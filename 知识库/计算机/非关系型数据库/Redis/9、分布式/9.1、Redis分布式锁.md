> 随着业务发展的需要，原单体单机部署的系统被演化成分布式集群系统后，由于分布式系统多线程、多进程并且分布在不同机器上，这将使原单机部署情况下的并发控制铋策略失效，单纯的 Java API并不能提供分布式锁的能力。为了解决这个问题就需要一种跨JVM的互斥机制来控制共享资源的访问，这就是分布式锁要解决的问题

> 标签： #Redis #Redis命令 #Redis分布式锁 #锁 

## 9.1、加锁

当key不存在时才能set该key，同时设置过期时间：`set <key> <value> nx ex <expire>`

## 9.2、释放锁

可以通过自动过期或者使用`del <key>`手动释放

## 9.3、加锁、释放锁存在的问题

场景：如果业务逻辑的执行时间是 7s。执行流程如下：

1.  A业务逻辑没执行完，3秒后锁被自动释放
2.  B业务获取到锁，执行业务逻辑，3秒后锁被自动释放
3.  C业务获取到锁，执行业务逻辑
4.  A业务逻辑执行完成，开始释放锁，这时释放的是C的锁（因为key相同），导致C的业务只执行 1s 就被别人释放，最终等于没锁的情况

解决：加锁时，设置一个指定的唯一值，释放前获取这个值，判断是否自己的锁

使用Redisson和Lua脚本保证加锁解锁的原子性