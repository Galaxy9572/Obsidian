> æ ‡ç­¾ï¼š #Redis #RedisåŸºæœ¬æ•°æ®ç±»å‹ #Rediså‘½ä»¤

> ğŸ“ŒZSet ä¸Set éå¸¸ç›¸ä¼¼ï¼Œæ˜¯ä¸€ä¸ªæ²¡æœ‰é‡å¤å…ƒç´ çš„å­—ç¬¦ä¸²é›†åˆï¼Œä½†æœ‰åºé›†åˆçš„æ¯ä¸ªæˆå‘˜éƒ½å…³è”äº†ä¸€ä¸ªè¯„åˆ†(score)ç”¨æ¥æŒ‰ç…§ä»æœ€ä½åˆ†åˆ°æœ€é«˜åˆ†çš„æ–¹å¼æ’åºé›†åˆä¸­çš„æˆå‘˜ã€‚é›†åˆçš„æˆå‘˜æ˜¯å”¯ä¸€çš„ï¼Œä½†æ˜¯è¯„åˆ†å¯ä»¥é‡å¤ï¼Œå› ä¸ºå…ƒç´ æ˜¯æœ‰åºçš„ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆå¿«çš„æ ¹æ®è¯„åˆ†æˆ–è€…æ¬¡åºæ¥è·å–ä¸€ä¸ªèŒƒå›´çš„å…ƒç´ ã€‚è®¿é—®æœ‰åºé›†åˆçš„ä¸­é—´å…ƒç´ ä¹Ÿæ˜¯éå¸¸å¿«çš„,å› æ­¤èƒ½å¤Ÿä½¿ç”¨æœ‰åºé›†åˆä½œä¸ºä¸€ä¸ªæ²¡æœ‰é‡å¤æˆå‘˜çš„åˆ—è¡¨ã€‚

> å‚è€ƒï¼š [Redis Sorted-Sets | Redis](https://redis.io/docs/data-types/sorted-sets/)

### 1.1ã€åŸºæœ¬å‘½ä»¤

-   å°†ä¸€ä¸ªæˆ–å¤šä¸ª å…ƒç´ åŠå…¶ score åŠ å…¥åˆ°key ä¸­ï¼š`zadd <key> <score1> <value1> <score2> <value2>...`

-   è¿”å›æœ‰åºé›† key ä¸­ï¼Œä¸‹æ ‡åœ¨<start><stop>ä¹‹é—´çš„å…ƒç´ :   `zrange <key> <start> <stop> [withscores]`
    
    å¸¦ withscoresï¼Œå¯ä»¥è®©åˆ†æ•°ä¸€èµ·å’Œå€¼è¿”å›åˆ°ç»“æœé›†
    
-   è¿”å›æœ‰åºé›† key ä¸­ï¼Œæ‰€æœ‰ min â‰¤score â‰¤ max çš„æˆå‘˜ï¼š`zrangebyscore <key> <min> <max> [withscores] [limit offset count]`
    
    æœ‰åºé›†æˆå‘˜æŒ‰ score å€¼é€’å¢(ä»å°åˆ°å¤§)æ¬¡åºæ’åˆ—
    
-   è¿”å›æœ‰åºé›† key ä¸­ï¼Œæ‰€æœ‰ min â‰¤score â‰¤ max çš„æˆå‘˜ï¼Œæ”¹ä¸ºä»å¤§åˆ°å°æ’åˆ—ï¼š`zrevrangebyscore key <min> <max> [withscores] [limit offset count]`
    
-   ä¸ºå…ƒç´ çš„score åŠ ä¸Šå¢é‡ï¼š`zincrby <key> <increment> <value>`
    
-   åˆ é™¤è¯¥é›†åˆä¸‹ï¼ŒæŒ‡å®šå€¼çš„å…ƒç´ ï¼š`zrem <key> <value>`
    
-   ç»Ÿè®¡è¯¥é›†åˆï¼Œåˆ†æ•°åŒºé—´å†…çš„å…ƒç´ ä¸ªæ•°ï¼š`zcount <key> <min> <max>`
    
-   è¿”å›è¯¥å€¼åœ¨é›†åˆä¸­çš„æ’åï¼Œä»0å¼€å§‹ï¼š`zrank <key> <value>`
    

## 1.2ã€æ•°æ®ç»“æ„(å‹ç¼©åˆ—è¡¨/ZipListã€è·³è·ƒè¡¨/SkipList)

ZSetæœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼šZipListå’ŒSkipListï¼Œå½“å…ƒç´ æ•°é‡å°‘äº128ä¸”æ¯ä¸ªå…ƒç´ çš„é•¿åº¦å°äº64å­—èŠ‚çš„æ—¶å€™ï¼Œä½¿ç”¨ZipListï¼Œå¦åˆ™æ”¹ç”¨SkipList

### 1.2.1ã€ZipListå­˜å‚¨

æ¯ä¸ªé›†åˆå…ƒç´ ä½¿ç”¨ä¸¤ä¸ªç´§æŒ¨åœ¨ä¸€èµ·çš„å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹æ¥ä¿å­˜ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¿å­˜å…ƒç´ çš„æˆå‘˜ï¼Œç¬¬äºŒä¸ªå…ƒç´ ä¿å­˜å…ƒç´ çš„åˆ†å€¼

![[Pasted image 20230408114038.png]]

### 1.2.2ã€SkipListå­˜å‚¨

SkipListæŒ‰ä»å°åˆ°å¤§çš„é¡ºåºå­˜å‚¨åˆ†æ•°ï¼ŒSkipListæ¯ä¸ªå…ƒç´ çš„å€¼éƒ½æ˜¯[score, value]å¯¹

SkipListèƒ½å®ç°å¿«é€Ÿçš„æŒ‰åˆ†æ•°èŒƒå›´æŸ¥æ‰¾å…ƒç´ ï¼Œå®ƒå…‹æœäº†æœ‰åºé“¾è¡¨æ’å…¥å’ŒæŸ¥æ‰¾æ€§èƒ½ä¸é«˜çš„é—®é¢˜ï¼Œæ’å…¥å’ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(logN)

![[Pasted image 20230408114056.png]]

SkipListå®šä¹‰ï¼š

```C
typedef struct zskiplist {
    //è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹
    struct zskiplistNode {
    header,*tail;
    //è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡
    unsigned long length;
    //è¡¨ä¸­å±‚æ•°æœ€å¤§çš„èŠ‚ç‚¹çš„å±‚æ•°
    int level:
} zskiplist;
```

SkipListNodeå®šä¹‰ï¼š

```C
typedef struct zskiplistNode {
    // å±‚
    struct zskiplistLevel {
        // å‰è¿›æŒ‡é’ˆ
        struct zskiplistNode *forward;
        // è·¨åº¦
        unsigned int spanï¼›
    } Level[];
    // åé€€æŒ‡é’ˆ
    struct zskiplistNode *backward;
    // åˆ†å€¼
    double score;
    // æˆå‘˜å¯¹è±¡
    robj *objï¼›
} ZskiplistNodeï¼›
```

æ™®é€šæœ‰åºé“¾è¡¨çš„æ’å…¥éœ€è¦ä¸€ä¸ªä¸€ä¸ªå‘å‰æŸ¥æ‰¾æ˜¯å¦å¯ä»¥æ’å…¥ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦ä¸ºO(N)ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªé“¾è¡¨æ’å…¥23ï¼Œå°±éœ€è¦ä¸€ç›´æŸ¥æ‰¾åˆ°22å’Œ26ä¹‹é—´ã€‚

![[Pasted image 20230408114113.png]]

å¦‚æœèŠ‚ç‚¹èƒ½å¤Ÿè·³è¿‡ä¸€äº›èŠ‚ç‚¹ï¼Œè¿æ¥åˆ°æ›´é åçš„èŠ‚ç‚¹å°±å¯ä»¥ä¼˜åŒ–æ’å…¥é€Ÿåº¦

![[Pasted image 20230408114124.png]]

åœ¨ä¸Šé¢è¿™ä¸ªç»“æ„ä¸­ï¼Œæ’å…¥23çš„è¿‡ç¨‹æ˜¯

1.  å…ˆä½¿ç”¨ç¬¬2å±‚é“¾æ¥head->7->19->26ï¼Œå‘ç°26æ¯”23å¤§ï¼Œå°±å›åˆ°19
2.  å†ç”¨ç¬¬1å±‚è¿æ¥19->22->26ï¼Œå‘ç°æ¯”23å¤§ï¼Œé‚£ä¹ˆå°±æ’å…¥åˆ°26ä¹‹å‰ï¼Œ22ä¹‹å