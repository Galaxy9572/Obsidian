> 标签： #Redis #Redis常见问题 #Redis面试问题

> 问题描述

在使用事务进行秒杀场景的操作时，多个用户同时秒杀一件商品，由于Redis事务是乐观锁CAS实现，当第一个用户购买完商品，并修改完库存后，数据的版本号被改变，导致后来的用户无法对库存数量进行修改从而导致商品无法卖出，导致库存遗留

> 问题现象

商品无法卖出，导致库存遗留

> 解决方案

将复杂的或者多步的 redis操作写为一个脚本一次提交给 redis执行，减少反复连接 redis 的次数，提升性能。Lua 脚本类似redis 事务，有一定的原子性，不会被其他命令插队，可以完成一些redis 事务性的操作。 但是redis 的 Lua脚本功能，只有在 Redis 2.6以上的版本才可以使用。利用 Lua 脚本淘汰用户，解决超卖问题。redis 2.6 版本以后，通过lua 脚本解决争抢问题，实际上是 redis 利用其单线程的特性，用任务队列的方式解决多任务井发问题。